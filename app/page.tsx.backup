'use client';

import React, { useState, useRef, useEffect } from 'react';
import { MessageCircle, Plus, Send, Bot, User, Trash2, RefreshCw, Paperclip, FileText, X, Upload, Edit2, Check, X as XIcon, ChevronLeft, ChevronRight, Receipt, Database, Download, BarChart3, FileText as FileTextIcon, Calculator, CreditCard, GripVertical, Zap } from 'lucide-react';
import { cn } from '@/lib/utils';

interface Attachment {
  id: string;
  name: string;
  type: string;
  size: number;
  url?: string;
  content?: string;
}

interface Message {
  id: string;
  content: string;
  role: 'user' | 'assistant';
  timestamp: Date;
  attachments?: Attachment[];
}

interface ChatSession {
  id: string;
  title: string;
  messages: Message[];
  createdAt: Date;
}

const recommendedActions = [
];

const modules = [
];

export default function FinanceAIChat() {
  const [sessions, setSessions] = useState<ChatSession[]>([]);
  const [currentSession, setCurrentSession] = useState<ChatSession | null>(null);
  const [inputMessage, setInputMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [attachments, setAttachments] = useState<Attachment[]>([]);
  const [editingSessionId, setEditingSessionId] = useState<string | null>(null);
  const [editingTitle, setEditingTitle] = useState('');
  const [leftSidebarCollapsed, setLeftSidebarCollapsed] = useState(false);
  const [rightSidebarCollapsed, setRightSidebarCollapsed] = useState(false);
  const [rightSidebarWidth, setRightSidebarWidth] = useState(280);
  const [isResizing, setIsResizing] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const titleInputRef = useRef<HTMLInputElement>(null);

  const createNewSession = () => {
    const newSession: ChatSession = {
      id: Date.now().toString(),
      title: `æ–°å¯¹è¯ ${sessions.length + 1}`,
      messages: [],
      createdAt: new Date()
    };
    setSessions([newSession, ...sessions]);
    setCurrentSession(newSession);
    setAttachments([]);
  };

  const deleteSession = (sessionId: string) => {
    setSessions(sessions.filter(s => s.id !== sessionId));
    if (currentSession?.id === sessionId) {
      setCurrentSession(sessions.length > 1 ? sessions[1] : null);
    }
  };

  const startEditingTitle = (session: ChatSession) => {
    setEditingSessionId(session.id);
    setEditingTitle(session.title);
    setTimeout(() => {
      titleInputRef.current?.focus();
      titleInputRef.current?.select();
    }, 100);
  };

  const saveTitle = () => {
    if (!editingSessionId || !editingTitle.trim()) return;
    
    const updatedSessions = sessions.map(session => 
      session.id === editingSessionId 
        ? { ...session, title: editingTitle.trim() }
        : session
    );
    
    setSessions(updatedSessions);
    
    if (currentSession?.id === editingSessionId) {
      setCurrentSession({ ...currentSession, title: editingTitle.trim() });
    }
    
    setEditingSessionId(null);
    setEditingTitle('');
  };

  const cancelEditing = () => {
    setEditingSessionId(null);
    setEditingTitle('');
  };

  const handleTitleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      saveTitle();
    } else if (e.key === 'Escape') {
      cancelEditing();
    }
  };

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (!files) return;

    Array.from(files).forEach(file => {
      const attachment: Attachment = {
        id: Date.now().toString() + Math.random(),
        name: file.name,
        type: file.type,
        size: file.size,
        url: URL.createObjectURL(file)
      };
      setAttachments(prev => [...prev, attachment]);
    });

    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const removeAttachment = (attachmentId: string) => {
    setAttachments(prev => prev.filter(att => att.id !== attachmentId));
  };

  const processVouchers = async (attachments: Attachment[]) => {
    const processingResults = attachments.map(att => {
      const voucherTypes = ['å‘ç¥¨', 'æ”¶æ®', 'é“¶è¡Œå›žå•', 'åˆåŒ', 'æŠ¥é”€å•'];
      const randomType = voucherTypes[Math.floor(Math.random() * voucherTypes.length)];
      const amounts = [1000, 2500, 5000, 8000, 12000, 15000];
      const randomAmount = amounts[Math.floor(Math.random() * amounts.length)];
      
      return {
        fileName: att.name,
        type: randomType,
        amount: randomAmount,
        date: new Date().toLocaleDateString(),
        status: 'å·²è¯†åˆ«'
      };
    });

    return processingResults;
  };

  const sendMessage = async (content: string) => {
    if ((!content.trim() && attachments.length === 0) || !currentSession) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      content: content || (attachments.length > 0 ? `ä¸Šä¼ äº† ${attachments.length} ä¸ªå‡­è¯é™„ä»¶` : ''),
      role: 'user',
      timestamp: new Date(),
      attachments: attachments.length > 0 ? [...attachments] : undefined
    };

    const updatedSession = {
      ...currentSession,
      messages: [...currentSession.messages, userMessage]
    };

    setSessions(sessions.map(s => s.id === currentSession.id ? updatedSession : s));
    setCurrentSession(updatedSession);
    setInputMessage('');
    setIsLoading(true);

    setTimeout(async () => {
      let aiResponse = '';
      
      if (attachments.length > 0) {
        const results = await processVouchers(attachments);
        aiResponse = `âœ… å‡­è¯å¤„ç†å®Œæˆï¼\n\nå·²æˆåŠŸè¯†åˆ«å¹¶å½•å…¥ä»¥ä¸‹å‡­è¯ï¼š\n\n${results.map(result => 
          `ðŸ“„ ${result.fileName}\n   - ç±»åž‹ï¼š${result.type}\n   - é‡‘é¢ï¼šÂ¥${result.amount.toLocaleString()}\n   - æ—¥æœŸï¼š${result.date}\n   - çŠ¶æ€ï¼š${result.status}\n`
        ).join('\n')}\n\næ‰€æœ‰å‡­è¯å·²è‡ªåŠ¨å½•å…¥è´¢åŠ¡ç³»ç»Ÿï¼Œè¯·æ ¸å¯¹ä¿¡æ¯æ˜¯å¦æ­£ç¡®ã€‚`;
      } else {
        const aiResponses = [
          "æ ¹æ®æ‚¨çš„é—®é¢˜ï¼Œæˆ‘å»ºè®®ä»Žä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œåˆ†æžï¼šé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æŸ¥çœ‹ç›¸å…³çš„è´¢åŠ¡æ•°æ®ï¼›å…¶æ¬¡ï¼Œè¿›è¡Œå¸‚åœºçŽ¯å¢ƒåˆ†æžï¼›æœ€åŽï¼Œåˆ¶å®šç›¸åº”çš„ç­–ç•¥ã€‚",
          "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è´¢åŠ¡é—®é¢˜ã€‚è®©æˆ‘ä¸ºæ‚¨è¯¦ç»†åˆ†æžä¸€ä¸‹ï¼š1. é£Žé™©è¯„ä¼° 2. æ”¶ç›Šé¢„æµ‹ 3. å¸‚åœºè¶‹åŠ¿ 4. å»ºè®®æ–¹æ¡ˆã€‚",
          "åŸºäºŽæ‚¨æä¾›çš„ä¿¡æ¯ï¼Œæˆ‘çš„ä¸“ä¸šå»ºè®®æ˜¯ï¼šé‡ç‚¹å…³æ³¨çŽ°é‡‘æµç®¡ç†ï¼Œä¼˜åŒ–æˆæœ¬ç»“æž„ï¼Œå¹¶å»ºç«‹å®Œå–„çš„é£Žé™©æŽ§åˆ¶ä½“ç³»ã€‚",
          "ä»Žè´¢åŠ¡è§’åº¦æ¥è¯´ï¼Œè¿™ä¸ªé¡¹ç›®éœ€è¦è€ƒè™‘ï¼šæŠ•èµ„å›žæŠ¥çŽ‡ã€é£Žé™©ç³»æ•°ã€å¸‚åœºå‰æ™¯ç­‰å› ç´ ã€‚æˆ‘å»ºè®®è¿›è¡Œæ›´æ·±å…¥çš„åˆ†æžã€‚",
          "å…³äºŽç¨ŽåŠ¡ç­¹åˆ’ï¼Œæˆ‘å»ºè®®ï¼š1. åˆç†åˆ©ç”¨ç¨Žæ”¶ä¼˜æƒ æ”¿ç­– 2. ä¼˜åŒ–ä¼ä¸šç»“æž„ 3. åˆè§„ç»è¥ 4. å®šæœŸå’¨è¯¢ä¸“ä¸šç¨ŽåŠ¡å¸ˆã€‚"
        ];
        aiResponse = aiResponses[Math.floor(Math.random() * aiResponses.length)];
      }
      
      const aiMessage: Message = {
        id: (Date.now() + 1).toString(),
        content: aiResponse,
        role: 'assistant',
        timestamp: new Date()
      };

      const finalSession = {
        ...updatedSession,
        messages: [...updatedSession.messages, aiMessage]
      };

      setSessions(sessions.map(s => s.id === currentSession.id ? finalSession : s));
      setCurrentSession(finalSession);
      setIsLoading(false);
      setAttachments([]);
    }, 2000);
  };

  const handleRecommendedAction = (prompt: string) => {
    sendMessage(prompt);
  };

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const handleMouseDown = (e: React.MouseEvent) => {
    setIsResizing(true);
    e.preventDefault();
  };

  const handleMouseMove = (e: MouseEvent) => {
    if (!isResizing) return;
    
    const newWidth = window.innerWidth - e.clientX;
    if (newWidth > 200 && newWidth < 500) {
      setRightSidebarWidth(newWidth);
    }
  };

  const handleMouseUp = () => {
    setIsResizing(false);
  };

  useEffect(() => {
    if (isResizing) {
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isResizing]);

  return (
    <div className="flex h-screen bg-gray-50">
                          className="text-gray-400 hover:text-blue-600 transition-colors opacity-0 group-hover:opacity-100 p-1"
                          title="ç¼–è¾‘æ ‡é¢˜"
                        >
                          <Edit2 className="w-3 h-3" />
                        </button>
                      </div>
                    )}
                    <p className="text-xs text-gray-500 mt-1">
                    className="text-gray-400 hover:text-red-500 transition-colors p-1"
                    title="åˆ é™¤å¯¹è¯"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              )}
            </div>
          ))}
        </div>
        </div>

